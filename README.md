# Notes

## Accessing private repo

We are considering storing the testing suites in a private repo as a way of preventing users from simply accessing the code directly and thus evading any requirement to actually develop their own code.

Job 1 in implementing that approach is being able to access a (separate/different) private repo from a GitHub Action. The key elements of the GitHub Action required are as follows:

```yaml
jobs:
  build:
   # ...other stuff here...
    steps:
      - name: Access contents of private repo  # You can call this whatever you want
        uses: actions/checkout@v2  # This refers to the GitHub Action. Nothing to do with your target repo
        with:
          repository: TSSlade/autograder_secrets  # This is your target repo. Uses `orgname/reponame` format
          token: ${{ secrets.w241_autograder }}  # This is your PAT (personal access token). Uses `secrets.your-PAT-name-here` format
```

The critical piece which is not self-evident or easily Google-able (but I found ❇ [here](https://upptime.js.org/docs/get-started/#after-creating-your-repository) ❇) is that you need to specifically add your **PAT** to the _source_ repo of the GitHub Action. ([This StackOverflow respondent](https://stackoverflow.com/a/39530966) apparently had a similarly mystifying experience.) 😡

Once you've created your PAT (and saved it elsewhere, please!!), you add it to your repo like so:

1. Go to your repo's `Settings` tab
    > ![GitHub Settings Interface](img/github-settings.png?raw=true)
2. Select the `Secrets` option in the left navbar
    > ![GitHub Settings > Secrets Interface](img/add-secrets-to-repo.png?raw=true)
3. Select the `New repository secret` button in the top-right corner
    > ![GitHub Settings > Secrets > New repository secret Interface](img/secret-adding-interface.png?raw=true)
4. Add in the name you're going to enter in that `${{ secrets.your-PAT-name-here }}` line in the YAML file, then paste the token itself into the next field


Docs consulted along the way:
+ [GitHub Actions Docs: Creating a Personal Access Token](https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token) 👍🏻
+ [GitHub Actions Docs: Authentication in a Workflow](https://docs.github.com/en/actions/reference/authentication-in-a-workflow) 👎🏻
+ [GitHub Actions Docs: Quickstart](https://docs.github.com/en/actions/quickstart)
+ [GitHub Actions issues: possible to checkout or clone another repo?](https://github.com/actions/checkout/issues/24#issuecomment-526385787)
+ [GitHub Actions issues: retrieving the default branch name failed](https://github.com/actions/checkout/issues/347)

## Spinning up action

The key issue in getting this working is figuring out the proper location of the various component files and how to set the relative paths. This community post ([Path to Action in the same repository as workflow](https://github.community/t/path-to-action-in-the-same-repository-as-workflow/16952)) was the one that finally got everything clicking. The final arrangement looks something like this:

```bash
├── .github
│   ├── actions                     # Separating actions (components) from workflows makes sense
│   │   ├── Dockerfile              # Pulls the image from Dockerhub, copies in and executes the entrypoint.sh
│   │   ├── action.yml              # Defines inputs, outputs; -runs/image- has to resolve as a proper path
│   │   └── entrypoint.sh           # Does stuff. This is specific to our GitHub Action, not to Actions in general
│   └── workflows                   # This is where we store the YML files that link up the actions we store above
│       ├── ...elided...
│       └── main.yml                # This is the one we care about. --uses-- paths are either relative to GitHub public repos OR to your project root
├── README.md
...elided for parsimony...
```
The action.yml file has been cleaned up now, but see the below commits on the `greetings` branch for the errors generated by various permutations of the addresses/paths if you wish to reconstruct how we traced our way to this result.

```
2c69415 HEAD@{1}: commit: Updated paths, moved Dockerfile local to action.yml
9eee5ae HEAD@{2}: commit: Placed action in subfolder, updated paths
96cf275 HEAD@{3}: commit: Backing out the folder hierarchy
b50cdea HEAD@{4}: commit: Systematically testing addresses
51eee84 HEAD@{5}: commit: Consolidated yml files, updated address
b8c0755 HEAD@{6}: commit: Updated address of -uses-
da46f94 HEAD@{7}: commit: Updated repo name and Dockerfile pointer
c0b2e1c HEAD@{8}: commit: Updated to point to action file
b870579 HEAD@{9}: commit: Moved workflow to workflows
c731f1d HEAD@{10}: commit: Triggering a change...
```

There was also an issue with making sure the `shebang` on the `entrypoint.sh` hadn't been displaced out of the `first-line position` by my comments giving credit to original sources. (Don't trample over conventions, kids.) Realized and resolved that via this StackOverflow answer: [standard_init_linux.go:211: exec user process caused “exec format error”](https://stackoverflow.com/questions/58298774/standard-init-linux-go211-exec-user-process-caused-exec-format-error)

## Apropos of Nothing

Multiline strings in YAML syntax are 🍌 bananas 🍌: [How do I break a string in YAML over multiple lines?](https://stackoverflow.com/questions/3790454/how-do-i-break-a-string-in-yaml-over-multiple-lines)