# Adapted from GitHub Actions MWE for Docker containers
# https://docs.github.com/en/actions/creating-actions/creating-a-docker-container-action
# Started as main.yml in root folder

name: AutoGrader-PS2   # Shows in the 'Workflows' section (left sidebar) of the GitHub Actions tab

on:                             # What is going to trigger this Workflow?
  push:
    branches: [ ps2 ]

jobs:                           # What actually needs done? 1+ jobs can be added, will run in parallel by default
  ag-ps2:                       # Name for your consumption only: is not obviously exposed anywhere
    name: 'Autograding PS2'   # Shows in the 'Jobs' section (left sidebar) of the Actions>Runs view
    runs-on: ubuntu-latest
    steps:
      # To use this repository's private action,
      # you must check out the repository
      - name: '`Checkout` hook (standard) - REQd for EACH local action'    # Shows as a foldable/expandable entry in the Runs log interface
        uses: actions/checkout@v2

      - id: Copy-Answers
        name: 'Custom Step [1]: Move answers to persistent HOME'
        shell: bash
        # run: echo "${GITHUB_ACTION_PATH}"
        run: |
          echo "GitHub Action filesystem"
          echo "GH Workspace for local repo:"
          tree -L 2 "${GITHUB_WORKSPACE}"
          cp -r "${GITHUB_WORKSPACE}/${GITHUB_ACTOR}" "${HOME}/${GITHUB_ACTOR}"
        # echo "GH Home:"
        # tree -L 2 "${HOME}"
        # echo "GH Actions folder?:"
        # tree -L 2 "${GITHUB_WORKSPACE}/../../_actions/actions/"

      - id: Fetch-Suite
        name: 'Custom Step [2]: Go grab testing suite from instructor repo'
        uses: actions/checkout@v2
        with:
          repository: TSSlade/autograder_secrets   # The (private) repo where our data is living
          ref: ps2                                  # The specific branch to be checked out
          token: ${{ secrets.w241_autograder }}     # This PAT needs to be configured in the src repo (i.e. the one mentioned 2 lines up)

      - id: Store-Suite
        name: "Custom Step [3]: Moving payload to persistent HOME"
        shell: bash
        run: |
          cp -r "${GITHUB_WORKSPACE}/ps2" "${HOME}/ps2"
          mkdir "${HOME}/ps2/student"
          cp -r "${HOME}/${GITHUB_ACTOR}" "${HOME}/ps2/student/${GITHUB_ACTOR}"
          echo "GH HOME/ps2:"
          tree -L 2 "${HOME}/ps2"
          echo "GH Root:"
          tree -L 2 /

      - name: '`Checkout` hook (standard) - REQd for EACH local action'    # Shows as a foldable/expandable entry in the Runs log interface
        uses: actions/checkout@v2

      - id: Docker-Up
        name: 'Custom Step [4]: Spinning up Docker Container via AG/action.yml'
        uses: ./.github/actions/AG                  # Runs DockerUp.sh at the end...

      - id: Execute-Suite
        name: 'Custom Step [5]: Running test suite'
        shell: bash
        # run: echo "${GITHUB_ACTION_PATH}"
        run: |
          cp -r "${HOME}/${GITHUB_ACTOR}" "${HOME}/ps2/student/${GITHUB_ACTOR}"
          tree -L 2 "${HOME}/ps2/student/${GITHUB_ACTOR}"
          sh "${HOME}/ps2/test_ps2.sh"

    # chmod +x "${GITHUB_WORKSPACE}/../.github/actions/AG/AG-move-ps2.sh"
    # # run script
    # "${GITHUB_WORKSPACE}/.github/actions/AG/AG-move-ps2.sh"

    #   # - id: Run-Suite
    #   #   name: 'Custom Step [4]: Run Alex's script over student folders'
    #   #   shell: bash
    #   #   run: |
    #   #     sh .github/actions/AG/AG-test-ps2.sh
    #   # Use the output from the `hello` step

    #   - name: 'Custom Step [5]: What time did we run this?'
    #     run: echo "The time was ${{ steps.Docker-Up.outputs.time }}"


    # # steps:
    # #   - name: Access contents of private repo
    # #     # env:
    # #       # GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    # #     uses: actions/checkout@v2
    # #     with:
    # #       repository: TSSlade/autograder_secrets
    # #       token: ${{ secrets.w241_autograder }}